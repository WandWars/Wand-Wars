<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° WAND WARS ‚Äî Online Duel ‚ö°</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: radial-gradient(ellipse at center, #1a0a2e 0%, #0a0412 70%, #000 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            color: #e0d5c1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px
        }

        .title {
            font-family: 'Georgia', serif;
            font-size: 4vw;
            color: #ffd700;
            text-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
            letter-spacing: 6px;
            margin-bottom: 10px
        }

        .subtitle {
            font-size: 1.2vw;
            color: #b8860b;
            letter-spacing: 8px;
            margin-bottom: 30px
        }

        .container {
            background: rgba(10, 4, 18, 0.9);
            border: 2px solid rgba(218, 165, 32, 0.3);
            border-radius: 16px;
            padding: 30px 50px;
            max-width: 800px;
            width: 90%;
            text-align: center
        }

        .btn {
            font-family: 'Georgia', serif;
            font-size: 1.1vw;
            padding: 12px 40px;
            border: 2px solid #daa520;
            background: rgba(26, 10, 46, 0.8);
            color: #ffd700;
            cursor: pointer;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin: 10px;
            transition: all 0.3s;
            border-radius: 6px
        }

        .btn:hover {
            background: rgba(218, 165, 32, 0.2);
            box-shadow: 0 0 20px rgba(218, 165, 32, 0.4);
            transform: scale(1.03)
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none
        }

        .link-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #daa520;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9vw;
            color: #ffd700
        }

        input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #daa520;
            border-radius: 6px;
            padding: 12px 20px;
            font-size: 1vw;
            color: #ffd700;
            width: 100%;
            max-width: 400px;
            text-align: center;
            margin: 10px 0
        }

        input::placeholder {
            color: #888
        }

        .status {
            font-size: 1vw;
            color: #66bb6a;
            margin: 15px 0
        }

        .error {
            color: #ef5350
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0
        }

        .ccard {
            background: rgba(40, 20, 60, 0.6);
            border: 2px solid rgba(100, 80, 120, 0.3);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center
        }

        .ccard:hover:not(.disabled) {
            border-color: rgba(218, 165, 32, 0.6);
            transform: translateY(-2px)
        }

        .ccard.picked {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4)
        }

        .ccard.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none
        }

        .ccard.taken {
            border-color: #ef5350;
            opacity: 0.5
        }

        .ccard .cname {
            font-size: 0.9vw;
            color: #e0d5c1;
            font-weight: 700
        }

        .ccard .chouse {
            font-size: 0.7vw;
            color: #b8860b
        }

        .p1-label {
            color: #ff6b6b
        }

        .p2-label {
            color: #6bc5ff
        }

        .ready-status {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0
        }

        .ready-box {
            padding: 15px 30px;
            border-radius: 8px;
            border: 2px solid rgba(100, 80, 120, 0.3)
        }

        .ready-box.ready {
            border-color: #66bb6a;
            background: rgba(102, 187, 106, 0.1)
        }

        .hidden {
            display: none !important
        }

        .waiting {
            font-size: 1.5vw;
            color: #ffa726;
            margin: 20px 0;
            animation: pulse 1.5s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.5
            }
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 0.9vw;
            padding: 8px 20px
        }

        .config-error {
            background: rgba(239, 83, 80, 0.1);
            border: 2px solid #ef5350;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0
        }

        .config-error code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px
        }
    </style>
</head>

<body>
    <button class="btn back-btn" onclick="window.location.href='index.html'">‚Üê BACK</button>
    <div class="title">WAND WARS</div>
    <div class="subtitle">‚ö° ONLINE DUEL ‚ö°</div>

    <div class="container hidden" id="config-error">
        <div class="config-error">
            <h2 style="color:#ef5350;margin-bottom:15px">‚ö†Ô∏è Supabase Not Configured</h2>
            <p>To enable online multiplayer, configure <code>supabase-config.js</code></p>
        </div>
        <button class="btn" onclick="window.location.href='index.html'">‚Üê BACK TO MENU</button>
    </div>

    <div class="container hidden" id="lobby-screen">
        <h2 style="color:#ffd700;margin-bottom:20px">Choose Your Path</h2>
        <button class="btn" id="create-btn">üè∞ CREATE ROOM</button>
        <p style="margin:15px 0;color:#888">‚Äî or ‚Äî</p>
        <input type="text" id="room-input" placeholder="Enter Room Code">
        <br>
        <button class="btn" id="join-btn">‚öî JOIN ROOM</button>
        <div id="lobby-status" class="status"></div>
    </div>

    <div class="container hidden" id="host-waiting">
        <h2 style="color:#ffd700;margin-bottom:15px">üè∞ Room Created!</h2>
        <p style="color:#aaa;margin-bottom:10px">Share this code with your friend:</p>
        <div class="link-box" id="room-code" style="font-size:2vw;letter-spacing:8px"></div>
        <p style="color:#888;font-size:0.8vw;margin:10px 0">Or share this link:</p>
        <div class="link-box" id="share-link" style="font-size:0.8vw"></div>
        <button class="btn" id="copy-btn" style="font-size:0.8vw;padding:8px 20px">üìã COPY LINK</button>
        <div class="waiting">Waiting for opponent to join...</div>
        <div id="host-status" class="status"></div>
    </div>

    <div class="container hidden" id="select-screen" style="max-width:1000px">
        <h2 style="color:#ffd700;margin-bottom:10px">‚öî Choose Your Wizard ‚öî</h2>
        <p style="color:#aaa;font-size:0.9vw;margin-bottom:15px">Pick different characters ‚Äî first come, first served!
        </p>
        <div id="char-grid" class="char-grid"></div>
        <div class="ready-status">
            <div class="ready-box" id="p1-ready"><span class="p1-label">You:</span> <span
                    id="my-status">Choosing...</span></div>
            <div class="ready-box" id="p2-ready"><span class="p2-label">Opponent:</span> <span
                    id="opp-status">Choosing...</span></div>
        </div>
        <button class="btn" id="ready-btn" disabled>‚úì I'M READY</button>
    </div>

    <div class="container hidden" id="starting-screen">
        <h2 style="color:#ffd700">‚ö° DUEL STARTING! ‚ö°</h2>
        <div class="waiting">Preparing battlefield...</div>
    </div>

    <script>
        (function () {
            const CHARS = [
                { id: 'harry', name: 'Harry Potter', house: 'Gryffindor' },
                { id: 'hermione', name: 'Hermione Granger', house: 'Gryffindor' },
                { id: 'ron', name: 'Ron Weasley', house: 'Gryffindor' },
                { id: 'dumbledore', name: 'Dumbledore', house: 'Gryffindor' },
                { id: 'voldemort', name: 'Lord Voldemort', house: 'Slytherin' },
                { id: 'snape', name: 'Severus Snape', house: 'Slytherin' },
                { id: 'bellatrix', name: 'Bellatrix Lestrange', house: 'Slytherin' },
                { id: 'draco', name: 'Draco Malfoy', house: 'Slytherin' }
            ];

            let supabaseClient = null;
            let channel = null;
            let isHost = false;
            let roomId = null;
            let myId = 'player-' + Math.random().toString(36).substr(2, 8);
            let myPick = null;
            let opponentPick = null;
            let myReady = false;
            let opponentReady = false;

            function init() {
                if (!window.SUPABASE_CONFIG || !window.SUPABASE_CONFIG.isConfigured) {
                    document.getElementById('config-error').classList.remove('hidden');
                    return;
                }

                supabaseClient = window.supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.key
                );

                // Setup event listeners
                document.getElementById('create-btn').onclick = createRoom;
                document.getElementById('join-btn').onclick = joinRoom;
                document.getElementById('copy-btn').onclick = copyLink;
                document.getElementById('ready-btn').onclick = toggleReady;

                // Check for room in URL
                const params = new URLSearchParams(window.location.search);
                const joinId = params.get('room');
                if (joinId) {
                    document.getElementById('room-input').value = joinId;
                }

                document.getElementById('lobby-screen').classList.remove('hidden');
            }

            function generateRoomId() {
                return 'WW' + Math.random().toString(36).substr(2, 5).toUpperCase();
            }

            function createRoom() {
                roomId = generateRoomId();
                isHost = true;
                document.getElementById('lobby-status').textContent = 'Creating room...';

                setupChannel(function () {
                    const link = window.location.origin + window.location.pathname + '?room=' + roomId;
                    document.getElementById('room-code').textContent = roomId;
                    document.getElementById('share-link').textContent = link;
                    document.getElementById('lobby-screen').classList.add('hidden');
                    document.getElementById('host-waiting').classList.remove('hidden');
                });
            }

            function joinRoom() {
                const input = document.getElementById('room-input').value.trim().toUpperCase();
                if (!input) { alert('Enter a room code!'); return; }

                roomId = input.includes('ROOM=') ? input.split('ROOM=')[1].split('&')[0] : input;
                isHost = false;
                document.getElementById('lobby-status').textContent = 'Joining room...';

                setupChannel(function () {
                    channel.send({
                        type: 'broadcast',
                        event: 'player-joined',
                        payload: { playerId: myId }
                    });
                });
            }

            function setupChannel(onReady) {
                channel = supabaseClient.channel('room-' + roomId, {
                    config: { broadcast: { self: false } }
                });

                // Host receives this when joiner connects
                channel.on('broadcast', { event: 'player-joined' }, function () {
                    document.getElementById('host-status').textContent = 'Opponent connected!';
                    // Send welcome message back to joiner
                    setTimeout(function() {
                        channel.send({
                            type: 'broadcast',
                            event: 'host-welcome',
                            payload: { hostId: myId }
                        });
                    }, 500);
                    showCharacterSelect();
                });

                // Joiner receives this when host acknowledges
                channel.on('broadcast', { event: 'host-welcome' }, function () {
                    document.getElementById('lobby-status').textContent = 'Connected!';
                    showCharacterSelect();
                });

                channel.on('broadcast', { event: 'char-pick' }, function (msg) {
                    if (msg.payload.playerId !== myId) {
                        opponentPick = msg.payload.charId;
                        updateCharacterGrid();
                        updateReadyStatus();
                    }
                });

                channel.on('broadcast', { event: 'ready-state' }, function (msg) {
                    if (msg.payload.playerId !== myId) {
                        opponentReady = msg.payload.ready;
                        updateReadyStatus();
                        checkBothReady();
                    }
                });

                channel.on('broadcast', { event: 'game-start' }, function (msg) {
                    startGame(msg.payload.p1Char, msg.payload.p2Char);
                });

                channel.subscribe(function (status) {
                    if (status === 'SUBSCRIBED') {
                        console.log('Supabase channel subscribed:', roomId);
                        if (onReady) onReady();
                    }
                });
            }

            function showCharacterSelect() {
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('host-waiting').classList.add('hidden');
                document.getElementById('select-screen').classList.remove('hidden');
                buildCharacterGrid();
            }

            function buildCharacterGrid() {
                const grid = document.getElementById('char-grid');
                grid.innerHTML = '';
                CHARS.forEach(function (char) {
                    const card = document.createElement('div');
                    card.className = 'ccard';
                    card.id = 'char-' + char.id;
                    card.innerHTML = '<div class="cname">' + char.name + '</div><div class="chouse">' + char.house + '</div>';
                    card.onclick = function () { pickCharacter(char.id); };
                    grid.appendChild(card);
                });
            }

            function updateCharacterGrid() {
                CHARS.forEach(function (char) {
                    const card = document.getElementById('char-' + char.id);
                    if (!card) return;
                    card.classList.remove('picked', 'taken', 'disabled');
                    if (char.id === myPick) {
                        card.classList.add('picked');
                    } else if (char.id === opponentPick) {
                        card.classList.add('taken', 'disabled');
                    }
                });
            }

            function pickCharacter(charId) {
                if (charId === opponentPick || myReady) return;

                myPick = charId;
                updateCharacterGrid();
                document.getElementById('ready-btn').disabled = false;

                channel.send({
                    type: 'broadcast',
                    event: 'char-pick',
                    payload: { playerId: myId, charId: charId }
                });
                updateReadyStatus();
            }

            function toggleReady() {
                if (!myPick) return;
                myReady = !myReady;
                document.getElementById('ready-btn').textContent = myReady ? '‚úó CANCEL' : '‚úì I\'M READY';
                document.getElementById('ready-btn').style.borderColor = myReady ? '#ef5350' : '#daa520';

                channel.send({
                    type: 'broadcast',
                    event: 'ready-state',
                    payload: { playerId: myId, ready: myReady }
                });
                updateReadyStatus();
                checkBothReady();
            }

            function updateReadyStatus() {
                var myChar = CHARS.find(function (c) { return c.id === myPick; });
                var oppChar = CHARS.find(function (c) { return c.id === opponentPick; });

                document.getElementById('my-status').textContent = myPick
                    ? (myReady ? myChar.name + ' ‚úì' : myChar.name)
                    : 'Choosing...';
                document.getElementById('opp-status').textContent = opponentPick
                    ? (opponentReady ? oppChar.name + ' ‚úì' : oppChar.name)
                    : 'Choosing...';

                document.getElementById('p1-ready').classList.toggle('ready', myReady);
                document.getElementById('p2-ready').classList.toggle('ready', opponentReady);
            }

            function checkBothReady() {
                if (myReady && opponentReady && myPick && opponentPick && isHost) {
                    channel.send({
                        type: 'broadcast',
                        event: 'game-start',
                        payload: { p1Char: myPick, p2Char: opponentPick }
                    });
                    startGame(myPick, opponentPick);
                }
            }

            function startGame(p1Char, p2Char) {
                document.getElementById('select-screen').classList.add('hidden');
                document.getElementById('starting-screen').classList.remove('hidden');

                var myCharId = isHost ? p1Char : p2Char;
                var oppCharId = isHost ? p2Char : p1Char;
                var p1Name = CHARS.find(function (c) { return c.id === p1Char; }).name;
                var p2Name = CHARS.find(function (c) { return c.id === p2Char; }).name;

                setTimeout(function () {
                    document.getElementById('starting-screen').innerHTML =
                        '<h2 style="color:#ffd700">‚ö° MATCH SET! ‚ö°</h2>' +
                        '<p style="margin:20px 0;color:#aaa">Characters locked:</p>' +
                        '<div style="display:flex;justify-content:center;gap:40px;margin:20px 0">' +
                        '<div style="text-align:center"><span class="p1-label">' + (isHost ? 'You' : 'Opponent') + ':</span><br><strong>' + p1Name + '</strong></div>' +
                        '<div style="font-size:2vw;color:#ffd700">VS</div>' +
                        '<div style="text-align:center"><span class="p2-label">' + (isHost ? 'Opponent' : 'You') + ':</span><br><strong>' + p2Name + '</strong></div>' +
                        '</div>' +
                        '<p style="color:#66bb6a;margin-top:20px">‚úì No duplicate characters!</p>' +
                        '<button class="btn" style="margin-top:20px" onclick="location.reload()">NEW MATCH</button>' +
                        '<button class="btn" onclick="location.href=\'index.html\'">MAIN MENU</button>';
                }, 1500);
            }

            function copyLink() {
                const link = document.getElementById('share-link').textContent;
                navigator.clipboard.writeText(link).then(function () {
                    document.getElementById('copy-btn').textContent = '‚úì COPIED!';
                    setTimeout(function () { document.getElementById('copy-btn').textContent = 'üìã COPY LINK'; }, 2000);
                });
            }

            // Initialize when ready
            if (document.readyState === 'complete') {
                init();
            } else {
                window.addEventListener('load', init);
            }
        })();
    </script>
</body>

</html>